// ============================================================================
// CAPTAINNEWS.GR - SIMPLIFIED FRONTEND (Flat Data Approach)
// ============================================================================
// This frontend simply fetches pre-aggregated news.json generated by GitHub Actions
// No more CORS proxies, RSS parsing, or complex fetching logic!
// ============================================================================

// DOM Elements
const container = document.getElementById('newsContainer');
const loading = document.getElementById('loading');
const categorySelect = document.getElementById('categorySelect');

// Store all articles and track visible count per category
let allCategories = {};
let visibleCount = {};
let selectedCategory = 'all';
let autoRefreshInterval = null;
let countdownInterval = null;
let nextRefreshTime = null;

// RSS Feed Categories (for color/title mapping only - feeds are server-side now)
const RSS_FEEDS = {
    breaking: { title: 'Î•ÎšÎ¤Î‘ÎšÎ¤Î— Î•Î Î™ÎšÎ‘Î™Î¡ÎŸÎ¤Î—Î¤Î‘ & Î•Î›Î›Î‘Î”Î‘', color: 'red' },
    politicsGR: { title: 'Î ÎŸÎ›Î™Î¤Î™ÎšÎ‘ (Î•Î›Î›Î‘Î”Î‘)', color: 'purple' },
    worldPolitics: { title: 'Î ÎŸÎ›Î™Î¤Î™ÎšÎ‘ (Î Î‘Î“ÎšÎŸÎ£ÎœÎ™Î©Î£)', color: 'blue' },
    sports: { title: 'Î‘Î˜Î›Î—Î¤Î™Î£ÎœÎŸÎ£ & SUPER LEAGUE', color: 'green' },
    panathinaikos: { title: 'Î Î‘ÎÎ‘Î˜Î—ÎÎ‘ÎªÎšÎŸÎ£', color: 'lime' },
    tech: { title: 'Î¤Î•Î§ÎÎŸÎ›ÎŸÎ“Î™Î‘ & SCIENCE', color: 'pink' }
};

// ============================================================================
// MAIN FETCH FUNCTION - Simplified!
// ============================================================================
async function getNews() {
    try {
        const fetchTime = new Date();
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log(`ğŸš€ Fetching news from news.json at ${fetchTime.toLocaleTimeString('el-GR')}`);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        // Show loading skeleton
        showSkeletonLoaders();
        
        // Fetch the pre-aggregated news.json (with cache busting)
        const timestamp = Date.now();
        const response = await fetch(`news.json?t=${timestamp}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
        const newsData = await response.json();
        
        console.log(`ğŸ“° Loaded ${newsData.totalArticles} articles from ${newsData.successfulFeeds}/${newsData.totalFeeds} feeds`);
        console.log(`â° Last updated: ${new Date(newsData.lastUpdated).toLocaleString('el-GR')}`);
        
        // Update global categories
        allCategories = newsData.categories;
        
        // Initialize visible count for each category (9 articles initially)
        for (const key in allCategories) {
            if (!visibleCount[key]) {
                visibleCount[key] = 9;
            }
        }
        
        // Populate dropdown
        populateDropdown();
        
        // Render all categories
        renderNews(allCategories);
        
        // // Update cache display
        // updateCacheTimeDisplay(newsData.lastUpdated);
        
        // Start auto-refresh timer (reload every 15 minutes to check for updates)
        if (!autoRefreshInterval && !nextRefreshTime) {
            console.log('ğŸ”§ Setting up auto-refresh timer...');
            startAutoRefresh();
        } else {
            console.log('âœ“ Auto-refresh timer already running');
            if (nextRefreshTime) {
                console.log(`â° Next refresh at: ${new Date(nextRefreshTime).toLocaleTimeString('el-GR')}`);
            }
            // Restart countdown with updated time
            startCountdownTimer();
        }

    } catch (error) {
        console.error('âŒ Error loading news:', error);
        
        // Show error message
                container.innerHTML = `
                    <div class="text-center p-8 bg-[#1a1a1a] border border-red-500/30 rounded-lg">
                        <p class="text-red-400 font-bold mb-2 text-xl">âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬</p>
                        <p class="text-red-300 text-sm mb-1">${error.message}</p>
                <p class="text-zinc-500 text-xs mb-4">Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎµ Î½Î± Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯ Ï„Î¿ news.json</p>
                        <button onclick="getNews()" class="mt-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-6 py-2 rounded-lg transition-all">
                            Î ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ ÎÎ±Î½Î¬
                        </button>
                    </div>`;
    } finally {
            loading.classList.add('hidden');
    }
}

// ============================================================================
// SKELETON LOADERS
// ============================================================================
function showSkeletonLoaders() {
    let skeletonsHTML = '';
    
    const categoryOrder = ['breaking', 'politicsGR', 'worldPolitics', 'sports', 'panathinaikos', 'tech'];
    
    categoryOrder.forEach((key) => {
        if (!RSS_FEEDS[key]) return;
        
        const isFirst = key === 'breaking';
        
        skeletonsHTML += `
            <section class="mb-12" id="skeleton-${key}">
                <div class="skeleton skeleton-title ${isFirst ? 'w-80' : 'w-64'} mb-6"></div>
                
                ${isFirst ? `
                    <div class="mb-8 bg-[#1a1a1a] rounded-xl border border-zinc-800 overflow-hidden">
                        <div class="grid md:grid-cols-2 gap-0">
                            <div class="relative h-64 md:h-96 overflow-hidden bg-zinc-900">
                                <div class="skeleton-image"></div>
                            </div>
                            <div class="p-8 flex flex-col min-h-[300px]">
                                <div class="skeleton skeleton-title w-full mb-4"></div>
                                <div class="skeleton skeleton-title w-3/4 mb-4"></div>
                                <div class="skeleton skeleton-text w-full"></div>
                                <div class="skeleton skeleton-text w-full"></div>
                                <div class="skeleton skeleton-text w-2/3"></div>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${Array(isFirst ? 6 : 3).fill('').map(() => `
                        <div class="bg-[#1a1a1a] rounded-lg border border-zinc-800 overflow-hidden">
                            <div class="relative h-48 overflow-hidden bg-zinc-900">
                                <div class="skeleton-image"></div>
                            </div>
                            <div class="p-5">
                                <div class="skeleton skeleton-title w-full mb-3"></div>
                                <div class="skeleton skeleton-text w-full"></div>
                                <div class="skeleton skeleton-text w-3/4"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </section>
        `;
    });
    
    container.innerHTML = skeletonsHTML;
}

// ============================================================================
// RENDERING FUNCTIONS
// ============================================================================
function renderNews(categories) {
    const colorStyles = getColorStyles();

    let html = '';

    for (const [key, category] of Object.entries(categories)) {
        // Skip if a specific category is selected and this isn't it
        if (selectedCategory !== 'all' && selectedCategory !== key) continue;
        
        const styles = colorStyles[category.color];
        const totalArticles = category.articles.length;
        const articlesToShow = Math.min(visibleCount[key], totalArticles);
        const articles = category.articles.slice(0, articlesToShow);

        if (totalArticles === 0) {
        html += `
            <section class="mb-12" id="category-${key}">
                    <h2 class="text-2xl font-bold ${styles.titleClass} border-b border-zinc-800 pb-3 mb-6">
                    ${category.title}
                </h2>
                <div class="text-center p-8 bg-[#1a1a1a] border border-zinc-800 rounded-lg">
                    <p class="text-zinc-500 mb-2">âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î¬ÏÎ¸ÏÎ± Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</p>
                </div>
            </section>`;
            continue;
        }
        
        html += `
            <section class="mb-12" id="category-${key}">
                <h2 class="text-2xl font-bold ${styles.titleClass} border-b border-zinc-800 pb-3 mb-6 flex items-center gap-2">
                    ${category.title}
                    <span class="text-sm text-zinc-600 font-normal ml-auto">(${articlesToShow}/${totalArticles})</span>
                </h2>
        `;

        articles.forEach((art, index) => {
            const description = art.description ? stripHtml(art.description).substring(0, 120) + '...' : '';
            const longDescription = art.description ? stripHtml(art.description).substring(0, 250) + '...' : '';
            const date = new Date(art.pubDate);
            const relativeTime = getRelativeTime(date);
            const thumbnail = art.thumbnail;
            
            const placeholderIcons = {
                'red': 'ğŸš¨', 'purple': 'ğŸ›ï¸', 'blue': 'ğŸŒ',
                'green': 'âš½', 'lime': 'â˜˜ï¸', 'pink': 'ğŸ’»'
            };
            const placeholderIcon = placeholderIcons[category.color] || 'ğŸ“°';
            
            const badgeColors = {
                'red': 'bg-red-600', 'purple': 'bg-purple-600', 'blue': 'bg-blue-600',
                'green': 'bg-green-600', 'lime': 'bg-lime-600', 'pink': 'bg-pink-600'
            };
            const badgeColor = badgeColors[category.color] || 'bg-blue-600';

            // First article = HERO (responsive: fixed image height, flexible text, line-clamp so nothing overflows)
            if (index === 0) {
                html += `
                    <div class="mb-8 bg-[#1a1a1a] rounded-xl border border-zinc-800 ${styles.borderHover} transition-all duration-300 hover:shadow-2xl ${styles.shadow} overflow-hidden">
                        <a href="${art.link}" target="_blank" class="block group">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-0 md:min-h-[280px]">
                                ${thumbnail ? `
                                    <div class="relative w-full h-[200px] md:h-auto md:min-h-[280px] overflow-hidden bg-zinc-900 order-1">
                                        <img 
                                            src="${thumbnail}" 
                                            alt="${art.title}"
                                            class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-500"
                                            loading="eager"
                                            onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center bg-gradient-to-br from-zinc-800 to-zinc-900\\'><span class=\\'text-8xl opacity-30\\'>${placeholderIcon}</span></div>'"
                                        />
                                        <div class="absolute top-4 left-4 ${badgeColor} text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-lg">
                                            Î ÏÏŒÏƒÏ†Î±Ï„Î¿
                                        </div>
                                    </div>
                                ` : `
                                    <div class="relative w-full h-[200px] md:min-h-[280px] overflow-hidden bg-gradient-to-br from-zinc-800 to-zinc-900 flex items-center justify-center order-1">
                                        <span class="text-8xl opacity-30 group-hover:scale-110 transition-transform">${placeholderIcon}</span>
                                        <div class="absolute top-4 left-4 ${badgeColor} text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide shadow-lg">
                                            Î ÏÏŒÏƒÏ†Î±Ï„Î¿
                                        </div>
                                    </div>
                                `}
                                <div class="p-5 md:p-6 lg:p-8 flex flex-col justify-between order-2 min-h-0">
                                    <div class="flex-1 min-h-0">
                                        <h3 class="text-lg md:text-xl lg:text-2xl font-bold text-zinc-100 ${styles.titleHover} transition-colors mb-2 md:mb-3 leading-snug line-clamp-2 md:line-clamp-3">
                                            ${art.title}
                                        </h3>
                                        ${longDescription ? `<p class="text-zinc-400 text-sm md:text-base leading-relaxed line-clamp-3 md:line-clamp-4">${longDescription}</p>` : ''}
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-zinc-800 shrink-0">
                                        ${art.source ? `<p class="text-white text-xs md:text-sm mb-2">Î Î·Î³Î®: ${art.source}</p>` : ''}
                                        <div class="flex flex-wrap items-center gap-3">
                                            <span class="text-white text-xs md:text-sm font-medium flex items-center gap-2">
                                                <i class="fa-solid fa-clock"></i> ${relativeTime}
                                            </span>
                                            <button 
                                                onclick="handleShareClick(event, '${art.link.replace(/'/g, "\\'")}')"
                                                class="text-zinc-400 hover:text-white transition-colors p-1.5 md:p-2 hover:bg-zinc-800 rounded-lg"
                                                title="Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® link"
                                            >
                                                <i class="fa-solid fa-share-nodes text-xs md:text-sm"></i>
                                            </button>
                                            <span class="${styles.readMore} text-xs md:text-sm font-semibold opacity-100 flex items-center gap-2 ml-auto">
                                                Î”Î¹Î±Î²Î¬ÏƒÏ„Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± <i class="fa-solid fa-arrow-right"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
            } else {
                html += `
                    <div class="bg-[#1a1a1a] rounded-lg border border-zinc-800 ${styles.borderHover} transition-all duration-200 hover:shadow-xl ${styles.shadow} overflow-hidden flex flex-col h-full">
                        <a href="${art.link}" target="_blank" class="block group flex flex-col h-full">
                            ${thumbnail ? `
                                <div class="relative h-48 overflow-hidden bg-zinc-900">
                                    <img 
                                        src="${thumbnail}" 
                                        alt="${art.title}"
                                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                        loading="lazy"
                                        onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center bg-gradient-to-br from-zinc-800 to-zinc-900\\'><span class=\\'text-6xl opacity-30\\'>${placeholderIcon}</span></div>'"
                                    />
                                </div>
                            ` : `
                                <div class="relative h-48 overflow-hidden bg-gradient-to-br from-zinc-800 to-zinc-900 flex items-center justify-center">
                                    <span class="text-6xl opacity-30 group-hover:scale-110 transition-transform">${placeholderIcon}</span>
                                </div>
                            `}
                            <div class="p-5 flex flex-col flex-1">
                                <h3 class="text-base font-bold text-zinc-100 ${styles.titleHover} transition-colors line-clamp-2 mb-3 leading-snug">
                                    ${art.title}
                                </h3>
                                ${description ? `<p class="text-zinc-400 text-sm leading-relaxed mb-3 line-clamp-3">${description}</p>` : ''}
                                <div class="mt-auto">
                                    ${art.source ? `<p class="text-white text-xs mb-4">Î Î·Î³Î®: ${art.source}</p>` : ''}
                                    <div class="flex items-center justify-between pt-4 border-t border-zinc-800">
                                        <div class="flex items-center gap-2">
                                            <span class="text-white text-xs">ğŸ•’ ${relativeTime}</span>
                                            <button 
                                                onclick="handleShareClick(event, '${art.link.replace(/'/g, "\\'")}')"
                                                class="text-zinc-400 hover:text-white transition-colors p-1.5 hover:bg-zinc-800 rounded"
                                                title="Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® link"
                                            >
                                                <i class="fa-solid fa-share-nodes text-xs"></i>
                                            </button>
                                        </div>
                                        <span class="${styles.readMore} text-xs opacity-100">Î”Î¹Î±Î²Î¬ÏƒÏ„Îµ â†’</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>`;
            }
        });

        html += `</div>`;
        
        // Add "Load More" button
        if (totalArticles > articlesToShow) {
            const remainingArticles = totalArticles - articlesToShow;
            html += `
                <div class="mt-6 text-center">
                    <button 
                        onclick="loadMoreArticles('${key}')" 
                        class="bg-zinc-800 hover:bg-zinc-700 ${styles.titleClass} px-6 py-3 rounded-lg font-semibold transition-all transform hover:scale-105 active:scale-95 inline-flex items-center gap-2 border border-zinc-700"
                    >
                        <i class="fa-solid fa-plus"></i>
                        Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÏ‰Î½ (${Math.min(9, remainingArticles)} Î±Ï€ÏŒ ${remainingArticles})
                    </button>
                </div>`;
        }
        
        html += `</section>`;
    }

    container.innerHTML = html;
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
function getColorStyles() {
    return {
        red: {
            titleClass: 'text-red-400',
            borderHover: 'hover:border-red-500/50',
            titleHover: 'group-hover:text-red-400',
            shadow: 'hover:shadow-red-500/10',
            readMore: 'text-red-400'
        },
        purple: {
            titleClass: 'text-purple-400',
            borderHover: 'hover:border-purple-500/50',
            titleHover: 'group-hover:text-purple-400',
            shadow: 'hover:shadow-purple-500/10',
            readMore: 'text-purple-400'
        },
        green: {
            titleClass: 'text-green-400',
            borderHover: 'hover:border-green-500/50',
            titleHover: 'group-hover:text-green-400',
            shadow: 'hover:shadow-green-500/10',
            readMore: 'text-green-400'
        },
        lime: {
            titleClass: 'text-lime-400',
            borderHover: 'hover:border-lime-500/50',
            titleHover: 'group-hover:text-lime-400',
            shadow: 'hover:shadow-lime-500/10',
            readMore: 'text-lime-400'
        },
        blue: {
            titleClass: 'text-blue-400',
            borderHover: 'hover:border-blue-500/50',
            titleHover: 'group-hover:text-blue-400',
            shadow: 'hover:shadow-blue-500/10',
            readMore: 'text-blue-400'
        },
        pink: {
            titleClass: 'text-pink-400',
            borderHover: 'hover:border-pink-500/50',
            titleHover: 'group-hover:text-pink-400',
            shadow: 'hover:shadow-pink-500/10',
            readMore: 'text-pink-400'
        }
    };
}

function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
}

function getRelativeTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSeconds = Math.floor(diffMs / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffSeconds < 30) {
        return 'Î¼ÏŒÎ»Î¹Ï‚ Ï„ÏÏÎ±';
    } else if (diffMinutes < 1) {
        return 'Ï€ÏÎ¹Î½ Î±Ï€ÏŒ Î»Î¯Î³Î¿';
    } else if (diffMinutes < 60) {
        return `${diffMinutes} ${diffMinutes === 1 ? 'Î»ÎµÏ€Ï„ÏŒ' : 'Î»ÎµÏ€Ï„Î¬'} Ï€ÏÎ¹Î½`;
    } else if (diffHours < 24) {
        return `${diffHours} ${diffHours === 1 ? 'ÏÏÎ±' : 'ÏÏÎµÏ‚'} Ï€ÏÎ¹Î½`;
    } else if (diffDays < 7) {
        return `${diffDays} ${diffDays === 1 ? 'Î¼Î­ÏÎ±' : 'Î¼Î­ÏÎµÏ‚'} Ï€ÏÎ¹Î½`;
    } else {
        return date.toLocaleDateString('el-GR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
}

function loadMoreArticles(categoryKey) {
    visibleCount[categoryKey] += 9;
    renderNews(allCategories);
    
    const categoryElement = document.getElementById(`category-${categoryKey}`);
    if (categoryElement) {
        const scrollPosition = categoryElement.offsetTop - 100;
        window.scrollTo({ top: scrollPosition, behavior: 'smooth' });
    }
}

function updateCacheTimeDisplay(lastUpdated) {
    const cachedDate = new Date(lastUpdated);
    
    let cacheInfo = document.getElementById('cacheInfo');
    if (cacheInfo) cacheInfo.remove();
    
    cacheInfo = document.createElement('div');
    cacheInfo.id = 'cacheInfo';
    cacheInfo.className = 'text-center text-zinc-500 text-xs pb-8';
    
    // Calculate time since last update
    const now = Date.now();
    const timeSinceUpdate = Math.floor((now - new Date(lastUpdated).getTime()) / 1000);
    const minutesAgo = Math.floor(timeSinceUpdate / 60);
    const timeAgoText = minutesAgo < 1 ? 'Î¼ÏŒÎ»Î¹Ï‚ Ï„ÏÏÎ±' : `Ï€ÏÎ¹Î½ ${minutesAgo} Î»ÎµÏ€Ï„ÏŒ${minutesAgo !== 1 ? 'Î¬' : ''}`;
    
    cacheInfo.innerHTML = `
         Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: ${cachedDate.toLocaleString('el-GR')} (${timeAgoText}) | 
        <span id="nextRefreshCountdown">Î•Ï€ÏŒÎ¼ÎµÎ½Î· Î±Î½Î±Î½Î­Ï‰ÏƒÎ· ÏƒÎµ 5:00</span>
    `;
    container.insertAdjacentElement('beforebegin', cacheInfo);
    
    // Start countdown timer
    startCountdownTimer();
}

// Visual countdown timer for next refresh
function startCountdownTimer() {
    const countdownElement = document.getElementById('nextRefreshCountdown');
    if (!countdownElement) return;
    
    // Clear existing countdown interval
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    const updateCountdown = () => {
        if (!nextRefreshTime) {
            countdownElement.textContent = 'Î‘Î½Î±Î¼Î¿Î½Î®...';
            return;
        }
        
        const now = Date.now();
        const timeRemaining = Math.max(0, Math.floor((nextRefreshTime - now) / 1000));
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeRemaining <= 0) {
            countdownElement.textContent = 'Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Ï„ÏÏÎ±...';
        } else {
            countdownElement.textContent = `Î•Ï€ÏŒÎ¼ÎµÎ½Î· Î±Î½Î±Î½Î­Ï‰ÏƒÎ· ÏƒÎµ ${timeString}`;
        }
    };
    
    // Update immediately
    updateCountdown();
    
    // Update every second
    countdownInterval = setInterval(updateCountdown, 1000);
}

function populateDropdown() {
    categorySelect.innerHTML = '<option value="all">ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</option>';
    
    for (const [key, category] of Object.entries(RSS_FEEDS)) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = category.title;
        categorySelect.appendChild(option);
    }
    
    const saved = localStorage.getItem('selectedCategory');
    if (saved) {
        selectedCategory = saved;
        categorySelect.value = saved;
    }
}

function filterByCategory(categoryKey) {
    selectedCategory = categoryKey;
    localStorage.setItem('selectedCategory', categoryKey);
    
    if (Object.keys(allCategories).length > 0) {
        renderNews(allCategories);
    }
}

// Calculate milliseconds until next round 15-minute mark (e.g., 7:15:00, 7:30:00, 7:45:00, 8:00:00)
function getTimeUntilNextRoundInterval() {
    const now = new Date();
    
    // Clone current time and round UP to next 15-minute mark
    const next = new Date(now);
    const currentMinutes = next.getMinutes();
    const currentSeconds = next.getSeconds();
    const currentMilliseconds = next.getMilliseconds();
    
    // Calculate next round minute (0, 15, 30, 45)
    let nextRoundMinute;
    
    // If we're at a round minute with 0 seconds, jump to NEXT interval
    if (currentMinutes % 15 === 0 && currentSeconds === 0 && currentMilliseconds === 0) {
        nextRoundMinute = currentMinutes + 15;
    }
    // If we're at a round minute but past 0 seconds, jump to next interval
    else if (currentMinutes % 15 === 0 && (currentSeconds > 0 || currentMilliseconds > 0)) {
        nextRoundMinute = currentMinutes + 15;
    }
    // Otherwise, round up to next 15-minute mark
    else {
        nextRoundMinute = Math.ceil(currentMinutes / 15) * 15;
    }
    
    // Handle hour overflow (e.g., 55 -> 60 becomes next hour at 0)
    if (nextRoundMinute >= 60) {
        next.setHours(next.getHours() + 1);
        next.setMinutes(0);
    } else {
        next.setMinutes(nextRoundMinute);
    }
    
    // Always set to exact :00.000
    next.setSeconds(0);
    next.setMilliseconds(0);
    
    // Return milliseconds until that time
    const diff = next.getTime() - now.getTime();
    
    // Ensure we never return 0 or negative - always at least 1ms to next interval
    return Math.max(diff, 1);
}

function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // Calculate time until next "round" 15-minute mark (e.g., 7:15, 7:30, 7:45, 8:00...)
    const msUntilNext = getTimeUntilNextRoundInterval();
    nextRefreshTime = Date.now() + msUntilNext;
    
        const now = new Date();
    console.log('âœ… Auto-refresh configured to sync with clock (every :00, :15, :30, :45)');
    console.log(`â° Current time: ${now.toLocaleTimeString('el-GR')}`);
    console.log(`â° Next refresh at: ${new Date(nextRefreshTime).toLocaleTimeString('el-GR')} (in ${Math.floor(msUntilNext/1000)}s)`);
    
    // Schedule the first refresh at the next round 15-minute mark
    setTimeout(() => {
        console.log(`ğŸ”„ Auto-refresh triggered at ${new Date().toLocaleTimeString('el-GR')}`);
        
        // Calculate next round interval BEFORE calling getNews
        const nextInterval = getTimeUntilNextRoundInterval();
        nextRefreshTime = Date.now() + nextInterval;
        
        getNews();
        
        // After the first synchronized refresh, continue every 15 minutes exactly
        autoRefreshInterval = setInterval(() => {
            const nextInterval = getTimeUntilNextRoundInterval();
            nextRefreshTime = Date.now() + nextInterval;
            console.log(`ğŸ”„ Auto-refresh triggered at ${new Date().toLocaleTimeString('el-GR')}`);
            getNews();
        }, 900000); // 15 minutes = 900000ms
        
    }, msUntilNext);
}

// ============================================================================
// SHARE FUNCTIONALITY
// ============================================================================
function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            document.body.removeChild(textArea);
            return Promise.resolve();
        } catch (err) {
            document.body.removeChild(textArea);
            return Promise.reject(err);
        }
    }
}

function showToast(message) {
    // Remove existing toast if any
    const existingToast = document.getElementById('shareToast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.id = 'shareToast';
    toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-2xl z-50 flex items-center gap-2';
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    toast.style.transition = 'opacity 0.3s, transform 0.3s';
    toast.innerHTML = `
        <i class="fa-solid fa-check-circle"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

function handleShareClick(event, articleLink) {
    event.preventDefault();
    event.stopPropagation();
    
    copyToClipboard(articleLink)
        .then(() => {
            showToast('ğŸ”— Î¤Î¿ link Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ!');
        })
        .catch((err) => {
            console.error('Failed to copy:', err);
            showToast('âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î®Ï‚');
        });
}

// ============================================================================
// INITIALIZATION
// ============================================================================
window.getNews = getNews;
window.filterByCategory = filterByCategory;
window.loadMoreArticles = loadMoreArticles;
window.handleShareClick = handleShareClick;

window.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸš€ CaptainNews.gr - Flat Data Edition');
    populateDropdown();
    getNews();
});
